<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="description" content="关于程序与设计、黑客与画家 | 缪世伟，Web & Mobile Lover，Software Engineer，UX Designer | 这里是 @Yoko缪世伟 的个人博客，与你一起发现更大的世界。">
    <meta name="keywords"  content="缪世伟, Yoko缪世伟, Yoko, 鬼栈, Yoko, @Yoko, 缪世伟的博客, Yoko Blog, 博客, 个人网站, 游戏, Shader, UE4, Unity, 设计, 计算机图形学">
    <meta name="theme-color" content="#000000">
    
    <!-- Open Graph -->
    <meta property="og:title" content="「HDRP」Unity Toon Hair Rendering - Yoko的博客 | Yoko Blog">
    
    <meta property="og:type" content="article">
    <meta property="og:description" content="材质解析
">
    
    <meta property="article:published_time" content="2019-10-23T00:00:00Z">
    
    
    <meta property="article:author" content="Yoko">
    
    
    <meta property="article:tag" content="图形学">
    
    <meta property="article:tag" content="Shader">
    
    <meta property="article:tag" content="CG">
    
    <meta property="article:tag" content="Toon">
    
    
    <meta property="og:image" content="http://localhost:4000/img/avatar-hux-ny.jpg">
    <meta property="og:url" content="http://localhost:4000/2019/10/23/Toon-Hair-Rendering/">
    <meta property="og:site_name" content="Yoko的博客 | Yoko Blog">
    
    <title>「HDRP」Unity Toon Hair Rendering - Yoko的博客 | Yoko Blog</title>

    <!-- Web App Manifest -->
    <link rel="manifest" href="/pwa/manifest.json">

    <!-- Favicon -->
    <link rel="shortcut icon" href="/img/favicon.ico">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="http://localhost:4000/2019/10/23/Toon-Hair-Rendering/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/hux-blog.min.css">

    <!-- Custom Fonts -->
    <!-- <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->

    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
        
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/">Yoko Blog</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div id="huxblog_navbar">
                <div class="navbar-collapse">
                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="/">Home</a>
                        </li>
                        
                        
                        
                        
                        <li>
                            <a href="/about/">About</a>
                        </li>
                        
                        
                        
                        <li>
                            <a href="/archive/">Archive</a>
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <li class="search-icon">
                            <a href="javascript:void(0)">
                                <i class="fa fa-search"></i>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

    <script>
        // Drop Bootstarp low-performance Navbar
        // Use customize navbar with high-quality material design animation
        // in high-perf jank-free CSS3 implementation
        var $body = document.body;
        var $toggle = document.querySelector('.navbar-toggle');
        var $navbar = document.querySelector('#huxblog_navbar');
        var $collapse = document.querySelector('.navbar-collapse');

        var __HuxNav__ = {
            close: function () {
                $navbar.className = " ";
                // wait until animation end.
                setTimeout(function () {
                    // prevent frequently toggle
                    if ($navbar.className.indexOf('in') < 0) {
                        $collapse.style.height = "0px"
                    }
                }, 400)
            },
            open: function () {
                $collapse.style.height = "auto"
                $navbar.className += " in";
            }
        }

        // Bind Event
        $toggle.addEventListener('click', function (e) {
            if ($navbar.className.indexOf('in') > 0) {
                __HuxNav__.close()
            } else {
                __HuxNav__.open()
            }
        })

        /**
         * Since Fastclick is used to delegate 'touchstart' globally
         * to hack 300ms delay in iOS by performing a fake 'click',
         * Using 'e.stopPropagation' to stop 'touchstart' event from 
         * $toggle/$collapse will break global delegation.
         * 
         * Instead, we use a 'e.target' filter to prevent handler
         * added to document close HuxNav.  
         *
         * Also, we use 'click' instead of 'touchstart' as compromise
         */
        document.addEventListener('click', function (e) {
            if (e.target == $toggle) return;
            if (e.target.className == 'icon-bar') return;
            __HuxNav__.close();
        })
    </script>
    <!-- Search -->
<div class="search-page">
  <div class="search-icon-close-container">
    <span class="search-icon-close">
      <i class="fa fa-chevron-down"></i>
    </span>
  </div>
  <div class="search-main container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <form></form>
        <input type="text" id="search-input" placeholder="$ grep...">
        </form>
        <div id="search-results" class="mini-post-list"></div>
      </div>
    </div>
  </div>
</div>

    <!-- Image to hack wechat -->
<!-- <img src="/img/icon_wechat.png" width="0" height="0"> -->
<!-- <img src="/img/post-bg-Toon-Hair-Rendering.jpg" width="0" height="0"> -->

<!-- Post Header -->



<style type="text/css">
    header.intro-header{
        position: relative;
        background-image: url('/img/post-bg-Toon-Hair-Rendering.jpg');
        background: ;
    }

    
</style>

<header class="intro-header" >

    <div class="header-mask"></div>
    
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/archive/?tag=%E5%9B%BE%E5%BD%A2%E5%AD%A6" title="图形学">图形学</a>
                        
                        <a class="tag" href="/archive/?tag=Shader" title="Shader">Shader</a>
                        
                        <a class="tag" href="/archive/?tag=CG" title="CG">CG</a>
                        
                        <a class="tag" href="/archive/?tag=Toon" title="Toon">Toon</a>
                        
                    </div>
                    <h1>「HDRP」Unity Toon Hair Rendering</h1>
                    
                    <h2 class="subheading">「HDRP」Unity实现崩坏3高质量卡通头发渲染</h2>
                    <span class="meta">Posted by Yoko on October 23, 2019</span>
                </div>
            </div>
        </div>
    </div>
</header>






<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <!-- Multi-Lingual -->
                

				<h1 id="材质解析"><strong>材质解析</strong></h1>

<p><img src="/img/in-post/post-toon-hair-rendering/effects-refrence.gif" alt="" /></p>

<h3 id="高光">高光</h3>

<ul>
  <li>低频固有高光+高频流动高光</li>
  <li>半角向量与法线夹角越小高光范围越大</li>
</ul>

<h3 id="阴影">阴影</h3>

<ul>
  <li>深色固有阴影+浅色动态阴影</li>
  <li>阴影形状近似球形</li>
</ul>

<h2 id="美术资源制作"><strong>美术资源制作</strong></h2>

<p>稍作分析可以发现都是比较简单的东西，标题的高质量完全靠美术来调整，稍后会提供用到的美术资源。
首先是球形的阴影，使用法线编辑工具修改法线以使阴影好看已经是卡通渲染必备的技术了。这里推荐2款插件：</p>

<ul>
  <li><a href="https://github.com/binarysudoku/NormalMagic">NormalMagic</a></li>
  <li><a href="https://github.com/unity3d-jp/NormalPainter">NormalPainter</a></li>
</ul>

<p>NormalMagic适用于max，有简单的功能，包括要用的替换法线的功能。NormalPainter是Unity JP分享的非常强大的适用于unity的法线编辑工具，甚至能将法线存入顶点色，非常实用。</p>

<p>模型导入max，使用插件将球体的法线替换给头发：</p>

<p><img src="/img/in-post/post-toon-hair-rendering/max.jpg" alt="" /></p>

<h2 id="导入引擎"><strong>导入引擎</strong></h2>

<p>导进Unity，由于HDRP的设置多而复杂，稍有错误效果则相差甚远，所以这里说一下需要注意的设置。</p>

<p><img src="/img/in-post/post-toon-hair-rendering/in-unity1.jpg" alt="" /></p>

<blockquote>
  <p>后处理仅开启曝光</p>
</blockquote>

<p><img src="/img/in-post/post-toon-hair-rendering/in-unity2.jpg" alt="" /></p>

<blockquote>
  <p>平行光</p>
</blockquote>

<p><img src="/img/in-post/post-toon-hair-rendering/in-unity3.jpg" alt="" /></p>

<blockquote>
  <p>设置中的默认后处理都关掉</p>
</blockquote>

<p><img src="/img/in-post/post-toon-hair-rendering/in-unity4.jpg" alt="" /></p>

<blockquote>
  <p>颜色空间 linear，颜色贴图勾上sRGB，非颜色无需</p>
</blockquote>

<p>关于Gamma和linear还有些需要注意的，Unity处理贴图的RGB通道和A通道的方式不同，比如一张LightMap，不勾选sRGB，直接采样RGB的结果和PS中一致，而A却有偏差，需要经过1.48的gamma校正才能和PS中一致，以上是个人观察所得结果，如有大佬知晓原因欢迎留言。下面开始写HDRP Shader。</p>

<h2 id="hdrp着色器制作"><strong>「HDRP」着色器制作</strong></h2>

<p>首先创建任意一个HDRP Shader，用Shader Graph创建以下属性和节点，并在Sample Texture2D节点上右键Show Generated Code：</p>

<p><img src="/img/in-post/post-toon-hair-rendering/shadergraph.jpg" alt="" /></p>

<p>生成的代码如下：</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
</pre></td><td class="rouge-code"><pre><span class="n">Shader</span> <span class="s">"Sample Texture 2D"</span>
<span class="p">{</span>
    <span class="n">Properties</span>
    <span class="p">{</span>
        <span class="p">[</span><span class="n">NoScaleOffset</span><span class="p">]</span><span class="n">_MainTex</span><span class="p">(</span><span class="s">"Texture2D"</span><span class="p">,</span> <span class="mi">2</span><span class="n">D</span><span class="p">)</span> <span class="o">=</span> <span class="s">"white"</span> <span class="p">{}</span>
    <span class="p">}</span>

    <span class="n">HLSLINCLUDE</span>
    <span class="cp">#include "Packages/com.unity.render-pipelines.core/ShaderLibrary/Common.hlsl"
</span>    <span class="cp">#include "Packages/com.unity.render-pipelines.core/ShaderLibrary/Packing.hlsl"
</span>    <span class="cp">#include "Packages/com.unity.render-pipelines.core/ShaderLibrary/NormalSurfaceGradient.hlsl"
</span>    <span class="cp">#include "Packages/com.unity.render-pipelines.core/ShaderLibrary/Color.hlsl"
</span>    <span class="cp">#include "Packages/com.unity.render-pipelines.core/ShaderLibrary/UnityInstancing.hlsl"
</span>    <span class="cp">#include "Packages/com.unity.render-pipelines.core/ShaderLibrary/EntityLighting.hlsl"
</span>    <span class="cp">#include "Packages/com.unity.shadergraph/ShaderGraphLibrary/ShaderVariables.hlsl"
</span>    <span class="cp">#include "Packages/com.unity.shadergraph/ShaderGraphLibrary/ShaderVariablesFunctions.hlsl"
</span>    <span class="cp">#include "Packages/com.unity.shadergraph/ShaderGraphLibrary/Functions.hlsl"
</span>    <span class="cp">#define SHADERGRAPH_PREVIEW 1
</span>
    <span class="n">CBUFFER_START</span><span class="p">(</span><span class="n">UnityPerMaterial</span><span class="p">)</span>
    <span class="n">CBUFFER_END</span>
    <span class="n">TEXTURE2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">);</span> <span class="n">SAMPLER</span><span class="p">(</span><span class="n">sampler_MainTex</span><span class="p">);</span> <span class="n">float4</span> <span class="n">_MainTex_TexelSize</span><span class="p">;</span>
    <span class="n">SAMPLER</span><span class="p">(</span><span class="n">_SampleTexture2D_99F63624_Sampler_3_Linear_Repeat</span><span class="p">);</span>

    <span class="k">struct</span> <span class="nc">SurfaceDescriptionInputs</span>
    <span class="p">{</span>
        <span class="n">half4</span> <span class="n">uv0</span><span class="p">;</span>
    <span class="p">};</span>


    <span class="k">struct</span> <span class="nc">SurfaceDescription</span>
    <span class="p">{</span>
        <span class="n">float4</span> <span class="n">RGBA_0</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="n">SurfaceDescription</span> <span class="n">PopulateSurfaceData</span><span class="p">(</span><span class="n">SurfaceDescriptionInputs</span> <span class="n">IN</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">SurfaceDescription</span> <span class="n">surface</span> <span class="o">=</span> <span class="p">(</span><span class="n">SurfaceDescription</span><span class="p">)</span><span class="mi">0</span><span class="p">;</span>
        <span class="n">float4</span> <span class="n">_SampleTexture2D_99F63624_RGBA_0</span> <span class="o">=</span> <span class="n">SAMPLE_TEXTURE2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">sampler_MainTex</span><span class="p">,</span> <span class="n">IN</span><span class="p">.</span><span class="n">uv0</span><span class="p">.</span><span class="n">xy</span><span class="p">);</span>
        <span class="kt">float</span> <span class="n">_SampleTexture2D_99F63624_R_4</span> <span class="o">=</span> <span class="n">_SampleTexture2D_99F63624_RGBA_0</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
        <span class="kt">float</span> <span class="n">_SampleTexture2D_99F63624_G_5</span> <span class="o">=</span> <span class="n">_SampleTexture2D_99F63624_RGBA_0</span><span class="p">.</span><span class="n">g</span><span class="p">;</span>
        <span class="kt">float</span> <span class="n">_SampleTexture2D_99F63624_B_6</span> <span class="o">=</span> <span class="n">_SampleTexture2D_99F63624_RGBA_0</span><span class="p">.</span><span class="n">b</span><span class="p">;</span>
        <span class="kt">float</span> <span class="n">_SampleTexture2D_99F63624_A_7</span> <span class="o">=</span> <span class="n">_SampleTexture2D_99F63624_RGBA_0</span><span class="p">.</span><span class="n">a</span><span class="p">;</span>
        <span class="n">surface</span><span class="p">.</span><span class="n">RGBA_0</span> <span class="o">=</span> <span class="n">float4</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">surface</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">struct</span> <span class="nc">GraphVertexInput</span>
    <span class="p">{</span>
        <span class="n">float4</span> <span class="n">vertex</span> <span class="o">:</span> <span class="n">POSITION</span><span class="p">;</span>
        <span class="n">float4</span> <span class="n">texcoord0</span> <span class="o">:</span> <span class="n">TEXCOORD0</span><span class="p">;</span>
        <span class="n">UNITY_VERTEX_INPUT_INSTANCE_ID</span>
    <span class="p">};</span>

    <span class="n">GraphVertexInput</span> <span class="n">PopulateVertexData</span><span class="p">(</span><span class="n">GraphVertexInput</span> <span class="n">v</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">v</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">ENDHLSL</span>

    <span class="n">SubShader</span>
    <span class="p">{</span>
        <span class="n">Tags</span> <span class="p">{</span> <span class="s">"RenderType"</span><span class="o">=</span><span class="s">"Opaque"</span> <span class="p">}</span>
        <span class="n">LOD</span> <span class="mi">100</span>

        <span class="n">Pass</span>
        <span class="p">{</span>
            <span class="n">HLSLPROGRAM</span>
            <span class="cp">#pragma vertex vert
</span>            <span class="cp">#pragma fragment frag
</span>
            <span class="k">struct</span> <span class="nc">GraphVertexOutput</span>
            <span class="p">{</span>
                <span class="n">float4</span> <span class="n">position</span> <span class="o">:</span> <span class="n">POSITION</span><span class="p">;</span>
                <span class="n">half4</span> <span class="n">uv0</span> <span class="o">:</span> <span class="n">TEXCOORD</span><span class="p">;</span>

            <span class="p">};</span>

            <span class="n">GraphVertexOutput</span> <span class="n">vert</span> <span class="p">(</span><span class="n">GraphVertexInput</span> <span class="n">v</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">PopulateVertexData</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>

                <span class="n">GraphVertexOutput</span> <span class="n">o</span><span class="p">;</span>
                <span class="n">float3</span> <span class="n">positionWS</span> <span class="o">=</span> <span class="n">TransformObjectToWorld</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">vertex</span><span class="p">);</span>
                <span class="n">o</span><span class="p">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">TransformWorldToHClip</span><span class="p">(</span><span class="n">positionWS</span><span class="p">);</span>
                <span class="n">float4</span> <span class="n">uv0</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="n">texcoord0</span><span class="p">;</span>
                <span class="n">o</span><span class="p">.</span><span class="n">uv0</span> <span class="o">=</span> <span class="n">uv0</span><span class="p">;</span>

                <span class="k">return</span> <span class="n">o</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">float4</span> <span class="n">frag</span> <span class="p">(</span><span class="n">GraphVertexOutput</span> <span class="n">IN</span> <span class="p">)</span> <span class="o">:</span> <span class="n">SV_Target</span>
            <span class="p">{</span>
                <span class="n">float4</span> <span class="n">uv0</span> <span class="o">=</span> <span class="n">IN</span><span class="p">.</span><span class="n">uv0</span><span class="p">;</span>

                <span class="n">SurfaceDescriptionInputs</span> <span class="n">surfaceInput</span> <span class="o">=</span> <span class="p">(</span><span class="n">SurfaceDescriptionInputs</span><span class="p">)</span><span class="mi">0</span><span class="p">;</span>
                <span class="n">surfaceInput</span><span class="p">.</span><span class="n">uv0</span> <span class="o">=</span> <span class="n">uv0</span><span class="p">;</span>

                <span class="n">SurfaceDescription</span> <span class="n">surf</span> <span class="o">=</span> <span class="n">PopulateSurfaceData</span><span class="p">(</span><span class="n">surfaceInput</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">all</span><span class="p">(</span><span class="n">isfinite</span><span class="p">(</span><span class="n">surf</span><span class="p">.</span><span class="n">RGBA_0</span><span class="p">))</span> <span class="o">?</span> <span class="n">half4</span><span class="p">(</span><span class="n">surf</span><span class="p">.</span><span class="n">RGBA_0</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">surf</span><span class="p">.</span><span class="n">RGBA_0</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">surf</span><span class="p">.</span><span class="n">RGBA_0</span><span class="p">.</span><span class="n">z</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">:</span> <span class="n">float4</span><span class="p">(</span><span class="mf">1.0</span><span class="n">f</span><span class="p">,</span> <span class="mf">0.0</span><span class="n">f</span><span class="p">,</span> <span class="mf">1.0</span><span class="n">f</span><span class="p">,</span> <span class="mf">1.0</span><span class="n">f</span><span class="p">);</span>

            <span class="p">}</span>
            <span class="n">ENDHLSL</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>以此为基础进行修改，先复制出来保存为.shader，修改shader名称，删除一些不需要的部分，整理一下之后看起来和builtin除了texture的声明、函数不同之外基本没啥区别：</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
</pre></td><td class="rouge-code"><pre><span class="n">Shader</span> <span class="s">"Jason Ma/Hair"</span>
<span class="p">{</span>
    <span class="n">Properties</span>
    <span class="p">{</span>
        <span class="n">_MainTex</span> <span class="p">(</span><span class="s">"Texture2D"</span><span class="p">,</span> <span class="mi">2</span><span class="n">D</span><span class="p">)</span> <span class="o">=</span> <span class="s">"white"</span> <span class="p">{</span> <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="n">HLSLINCLUDE</span>
    <span class="cp">#include "Packages/com.unity.render-pipelines.core/ShaderLibrary/Common.hlsl"
</span>    <span class="cp">#include "Packages/com.unity.render-pipelines.core/ShaderLibrary/Packing.hlsl"
</span>    <span class="cp">#include "Packages/com.unity.render-pipelines.core/ShaderLibrary/NormalSurfaceGradient.hlsl"
</span>    <span class="cp">#include "Packages/com.unity.render-pipelines.core/ShaderLibrary/Color.hlsl"
</span>    <span class="cp">#include "Packages/com.unity.render-pipelines.core/ShaderLibrary/UnityInstancing.hlsl"
</span>    <span class="cp">#include "Packages/com.unity.render-pipelines.core/ShaderLibrary/EntityLighting.hlsl"
</span>    <span class="cp">#include "Packages/com.unity.shadergraph/ShaderGraphLibrary/ShaderVariables.hlsl"
</span>    <span class="cp">#include "Packages/com.unity.shadergraph/ShaderGraphLibrary/ShaderVariablesFunctions.hlsl"
</span>    <span class="cp">#include "Packages/com.unity.shadergraph/ShaderGraphLibrary/Functions.hlsl"
</span>    
    <span class="n">CBUFFER_START</span><span class="p">(</span><span class="n">UnityPerMaterial</span><span class="p">)</span>
    
    <span class="n">CBUFFER_END</span>
    
    <span class="n">TEXTURE2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">);</span> <span class="n">SAMPLER</span><span class="p">(</span><span class="n">sampler_MainTex</span><span class="p">);</span>
    
    <span class="n">ENDHLSL</span>
    
    <span class="n">SubShader</span>
    <span class="p">{</span>
        <span class="n">Tags</span> <span class="p">{</span> <span class="s">"RenderType"</span> <span class="o">=</span> <span class="s">"Opaque"</span> <span class="s">"LightMode"</span> <span class="o">=</span> <span class="s">"ForwardOnly"</span> <span class="p">}</span>
        <span class="n">LOD</span> <span class="mi">100</span>
        
        <span class="n">Pass</span>
        <span class="p">{</span>
            <span class="n">HLSLPROGRAM</span>
            
            <span class="cp">#pragma vertex vert
</span>            <span class="cp">#pragma fragment frag
</span>            
            <span class="k">struct</span> <span class="nc">GraphVertexInput</span>
            <span class="p">{</span>
                <span class="n">float4</span> <span class="n">vertex</span><span class="o">:</span> <span class="n">POSITION</span><span class="p">;</span>
                <span class="n">float4</span> <span class="n">texcoord0</span><span class="o">:</span> <span class="n">TEXCOORD0</span><span class="p">;</span>
                <span class="n">UNITY_VERTEX_INPUT_INSTANCE_ID</span>
            <span class="p">};</span>
            <span class="k">struct</span> <span class="nc">GraphVertexOutput</span>
            <span class="p">{</span>
                <span class="n">float4</span> <span class="n">position</span><span class="o">:</span> <span class="n">POSITION</span><span class="p">;</span>
                <span class="n">half4</span> <span class="n">uv0</span><span class="o">:</span> <span class="n">TEXCOORD</span><span class="p">;</span>
            <span class="p">};</span>
            
            <span class="n">GraphVertexOutput</span> <span class="n">vert</span><span class="p">(</span><span class="n">GraphVertexInput</span> <span class="n">v</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">GraphVertexOutput</span> <span class="n">o</span><span class="p">;</span>
                <span class="n">float3</span> <span class="n">positionWS</span> <span class="o">=</span> <span class="n">TransformObjectToWorld</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">vertex</span><span class="p">.</span><span class="n">xyz</span><span class="p">);</span>
                <span class="n">o</span><span class="p">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">TransformWorldToHClip</span><span class="p">(</span><span class="n">positionWS</span><span class="p">);</span>
                <span class="n">o</span><span class="p">.</span><span class="n">uv0</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="n">texcoord0</span><span class="p">;</span>
                
                <span class="k">return</span> <span class="n">o</span><span class="p">;</span>
            <span class="p">}</span>
            
            <span class="n">float4</span> <span class="n">frag</span><span class="p">(</span><span class="n">GraphVertexOutput</span> <span class="n">IN</span><span class="p">)</span><span class="o">:</span> <span class="n">SV_Target</span>
            <span class="p">{</span>
                <span class="n">float4</span> <span class="n">uv0</span> <span class="o">=</span> <span class="n">IN</span><span class="p">.</span><span class="n">uv0</span><span class="p">;</span>
                
                <span class="n">float4</span> <span class="n">c</span> <span class="o">=</span> <span class="n">SAMPLE_TEXTURE2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">sampler_MainTex</span><span class="p">,</span> <span class="n">uv0</span><span class="p">.</span><span class="n">xy</span><span class="p">);</span>
                
                <span class="k">return</span> <span class="n">c</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">ENDHLSL</span>
            
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p><img src="/img/in-post/post-toon-hair-rendering/hair.jpg" alt="" /></p>

<blockquote>
  <p>初始效果</p>
</blockquote>

<p>然后收集我们需要的数据，为了获取这些数据要修改include，添加一些属性，修改结构体：</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
</pre></td><td class="rouge-code"><pre><span class="n">Properties</span>
    <span class="p">{</span>
        <span class="n">_MainTex</span> <span class="p">(</span><span class="s">"Color Map"</span><span class="p">,</span> <span class="mi">2</span><span class="n">D</span><span class="p">)</span> <span class="o">=</span> <span class="s">"white"</span> <span class="p">{</span> <span class="p">}</span>
        <span class="n">_LightMap</span> <span class="p">(</span><span class="s">"Light Map"</span><span class="p">,</span> <span class="mi">2</span><span class="n">D</span><span class="p">)</span> <span class="o">=</span> <span class="s">"white"</span> <span class="p">{</span> <span class="p">}</span>
        <span class="n">_Color</span> <span class="p">(</span><span class="s">"Color"</span><span class="p">,</span> <span class="n">Color</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">_ShadowColor</span> <span class="p">(</span><span class="s">"Shadow Color"</span><span class="p">,</span> <span class="n">Color</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">_DmcShadowIntensity</span> <span class="p">(</span><span class="s">"Dynamic Shadow Intensity"</span><span class="p">,</span> <span class="n">Range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="n">_ShadowThreshold</span> <span class="p">(</span><span class="s">"Shadow Threshold"</span><span class="p">,</span> <span class="n">Range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="p">[</span><span class="n">PowerSlider</span><span class="p">(</span><span class="mi">6</span><span class="p">)]</span><span class="n">_ShadowFeather</span> <span class="p">(</span><span class="s">"Shadow Feather"</span><span class="p">,</span> <span class="n">Range</span><span class="p">(</span><span class="mf">0.0001</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">=</span> <span class="mf">0.01</span>
    <span class="p">}</span>
    
    <span class="p">...</span>
    
    <span class="cp">#include "Packages/com.unity.render-pipelines.core/ShaderLibrary/Common.hlsl"
</span>    <span class="cp">#include "Packages/com.unity.render-pipelines.core/ShaderLibrary/Packing.hlsl"
</span>    <span class="cp">#include "Packages/com.unity.render-pipelines.core/ShaderLibrary/NormalSurfaceGradient.hlsl"
</span>    <span class="cp">#include "Packages/com.unity.render-pipelines.core/ShaderLibrary/Color.hlsl"
</span>    <span class="cp">#include "Packages/com.unity.render-pipelines.core/ShaderLibrary/UnityInstancing.hlsl"
</span>    <span class="cp">#include "Packages/com.unity.render-pipelines.core/ShaderLibrary/EntityLighting.hlsl"
</span>    
    <span class="cp">#include "Packages/com.unity.render-pipelines.high-definition/Runtime/ShaderLibrary/ShaderVariables.hlsl"
</span>    <span class="cp">#include "Packages/com.unity.render-pipelines.high-definition/Runtime/Lighting/Lighting.hlsl"
</span>    
    <span class="n">CBUFFER_START</span><span class="p">(</span><span class="n">UnityPerMaterial</span><span class="p">)</span>
    <span class="n">float4</span> <span class="n">_Color</span><span class="p">;</span>
    <span class="n">float4</span> <span class="n">_ShadowColor</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">_DmcShadowIntensity</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">_ShadowThreshold</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">_ShadowFeather</span><span class="p">;</span>
    <span class="n">CBUFFER_END</span>
    
    <span class="nf">TEXTURE2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">);</span> <span class="n">SAMPLER</span><span class="p">(</span><span class="n">sampler_MainTex</span><span class="p">);</span>
    <span class="n">TEXTURE2D</span><span class="p">(</span><span class="n">_LightMap</span><span class="p">);</span> <span class="n">SAMPLER</span><span class="p">(</span><span class="n">sampler_LightMap</span><span class="p">);</span>
    
    <span class="p">...</span>
   
            <span class="k">struct</span> <span class="nc">GraphVertexInput</span>
            <span class="p">{</span>
                <span class="n">float4</span> <span class="n">vertex</span><span class="o">:</span> <span class="n">POSITION</span><span class="p">;</span>
                <span class="n">float4</span> <span class="n">texcoord0</span><span class="o">:</span> <span class="n">TEXCOORD0</span><span class="p">;</span>
                <span class="n">float3</span> <span class="n">normal</span><span class="o">:</span> <span class="n">NORMAL</span><span class="p">;</span>
                <span class="n">UNITY_VERTEX_INPUT_INSTANCE_ID</span>
            <span class="p">};</span>
            <span class="k">struct</span> <span class="nc">GraphVertexOutput</span>
            <span class="p">{</span>
                <span class="n">float4</span> <span class="n">position</span><span class="o">:</span> <span class="n">POSITION</span><span class="p">;</span>
                <span class="n">half4</span> <span class="n">uv0</span><span class="o">:</span> <span class="n">TEXCOORD0</span><span class="p">;</span>
                <span class="n">float3</span> <span class="n">positionWS</span><span class="o">:</span> <span class="n">TEXCOORD1</span><span class="p">;</span>
                <span class="n">float3</span> <span class="n">normal</span><span class="o">:</span> <span class="n">TEXCOORD2</span><span class="p">;</span>
            <span class="p">};</span>
            
            <span class="n">GraphVertexOutput</span> <span class="nf">vert</span><span class="p">(</span><span class="n">GraphVertexInput</span> <span class="n">v</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">GraphVertexOutput</span> <span class="n">o</span><span class="p">;</span>
                <span class="c1">// 这里的World Space是相对于摄像机的</span>
                <span class="c1">//https://docs.unity3d.com/Packages/com.unity.render-pipelines.high-definition@7.1/manual/Camera-Relative-Rendering.html</span>
                <span class="n">float3</span> <span class="n">positionWS</span> <span class="o">=</span> <span class="n">TransformObjectToWorld</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">vertex</span><span class="p">.</span><span class="n">xyz</span><span class="p">);</span>
                <span class="n">o</span><span class="p">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">TransformWorldToHClip</span><span class="p">(</span><span class="n">positionWS</span><span class="p">);</span>
                <span class="n">o</span><span class="p">.</span><span class="n">positionWS</span> <span class="o">=</span> <span class="n">positionWS</span><span class="p">;</span>
                <span class="n">o</span><span class="p">.</span><span class="n">normal</span> <span class="o">=</span> <span class="n">TransformObjectToWorldNormal</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">normal</span><span class="p">);</span>
                <span class="n">o</span><span class="p">.</span><span class="n">uv0</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="n">texcoord0</span><span class="p">;</span>
                
                <span class="k">return</span> <span class="n">o</span><span class="p">;</span>
            <span class="p">}</span>
            
            <span class="n">float4</span> <span class="n">frag</span><span class="p">(</span><span class="n">GraphVertexOutput</span> <span class="n">i</span><span class="p">)</span><span class="o">:</span> <span class="n">SV_Target0</span>
            <span class="p">{</span>
                <span class="n">float4</span> <span class="n">uv0</span> <span class="o">=</span> <span class="n">i</span><span class="p">.</span><span class="n">uv0</span><span class="p">;</span>
                <span class="c1">//Packages\com.unity.render-pipelines.high-definition@7.1.6\Runtime\Lighting\LightDefinition.cs</span>
                <span class="n">DirectionalLightData</span> <span class="n">light</span> <span class="o">=</span> <span class="n">_DirectionalLightDatas</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
                <span class="n">float3</span> <span class="n">L</span> <span class="o">=</span> <span class="o">-</span><span class="n">light</span><span class="p">.</span><span class="n">forward</span><span class="p">.</span><span class="n">xyz</span><span class="p">;</span>
                <span class="n">float3</span> <span class="n">V</span> <span class="o">=</span> <span class="n">GetWorldSpaceNormalizeViewDir</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">positionWS</span><span class="p">);</span>
                <span class="n">float3</span> <span class="n">H</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">L</span> <span class="o">+</span> <span class="n">V</span><span class="p">);</span>
                <span class="n">float3</span> <span class="n">N</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">normal</span><span class="p">);</span>
                
                <span class="n">float4</span> <span class="n">c</span> <span class="o">=</span> <span class="n">SAMPLE_TEXTURE2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">sampler_MainTex</span><span class="p">,</span> <span class="n">uv0</span><span class="p">.</span><span class="n">xy</span><span class="p">);</span>
                
                <span class="k">return</span> <span class="n">c</span><span class="p">;</span>
            <span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p><img src="/img/in-post/post-toon-hair-rendering/light.jpg" alt="" /></p>

<p>一些需要注意的地方代码中已经标了注释，HDRP中的光照存放在了数组中，一个pass即可遍历所有光照，这里只接收第一个平行光，DirectionalLightData结构体可在注释中的路径中找到。
下面写一个最简单的Toon光照模型，公式是从<a href="https://github.com/unity3d-jp/UnityChanToonShaderVer2_Project/blob/release/legacy/2.0/Manual/UTS2_Manual_en.md">UTS2</a>抄来的：</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="n">float4</span> <span class="n">frag</span><span class="p">(</span><span class="n">GraphVertexOutput</span> <span class="n">i</span><span class="p">)</span><span class="o">:</span> <span class="n">SV_Target0</span>
<span class="p">{</span>
    <span class="p">...</span>
    
    <span class="kt">float</span> <span class="n">halfLambert</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">L</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">shadowStep</span> <span class="o">=</span> <span class="n">saturate</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="n">halfLambert</span> <span class="o">-</span> <span class="p">(</span><span class="n">_ShadowThreshold</span> <span class="o">-</span> <span class="n">_ShadowFeather</span><span class="p">))</span> <span class="o">/</span> <span class="n">_ShadowFeather</span><span class="p">);</span>
    
    <span class="n">float4</span> <span class="n">baseColor</span> <span class="o">=</span> <span class="n">SAMPLE_TEXTURE2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">sampler_MainTex</span><span class="p">,</span> <span class="n">uv0</span><span class="p">.</span><span class="n">xy</span><span class="p">)</span> <span class="o">*</span> <span class="n">_Color</span><span class="p">;</span>
    <span class="n">float4</span> <span class="n">shadowColor</span> <span class="o">=</span> <span class="n">baseColor</span> <span class="o">*</span> <span class="n">_ShadowColor</span><span class="p">;</span>
    
    <span class="n">float4</span> <span class="n">finalColor</span> <span class="o">=</span> <span class="n">lerp</span><span class="p">(</span><span class="n">baseColor</span><span class="p">,</span> <span class="n">shadowColor</span><span class="p">,</span> <span class="n">shadowStep</span><span class="p">);</span>
    
    <span class="k">return</span> <span class="n">finalColor</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p><img src="/img/in-post/post-toon-hair-rendering/basecolor.jpg" alt="" /></p>

<p>然后加入2层阴影，稍微调整颜色：Color(D4CFC9)、Shadow Color(A8A8A8)：</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="kt">float</span> <span class="n">shadowStep</span> <span class="o">=</span> <span class="p">...</span>

<span class="n">float4</span> <span class="n">lightMap</span> <span class="o">=</span> <span class="n">SAMPLE_TEXTURE2D</span><span class="p">(</span><span class="n">_LightMap</span><span class="p">,</span> <span class="n">sampler_LightMap</span><span class="p">,</span> <span class="n">uv0</span><span class="p">.</span><span class="n">xy</span><span class="p">);</span><span class="c1">// 未使用A通道所以未校正Gamma</span>
<span class="n">shadowStep</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">shadowStep</span><span class="p">,</span> <span class="n">lightMap</span><span class="p">.</span><span class="n">b</span><span class="p">);</span>

<span class="n">float4</span> <span class="n">baseColor</span> <span class="o">=</span> <span class="n">SAMPLE_TEXTURE2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">sampler_MainTex</span><span class="p">,</span> <span class="n">uv0</span><span class="p">.</span><span class="n">xy</span><span class="p">)</span> <span class="o">*</span> <span class="n">_Color</span><span class="p">;</span>
<span class="n">float4</span> <span class="n">dmcShadowColor</span> <span class="o">=</span> <span class="n">lerp</span><span class="p">((</span><span class="n">float4</span><span class="p">)</span><span class="mi">1</span><span class="p">,</span> <span class="n">_ShadowColor</span><span class="p">,</span> <span class="n">_DmcShadowIntensity</span><span class="p">);</span>
<span class="n">float4</span> <span class="n">shadowColor</span> <span class="o">=</span> <span class="n">baseColor</span> <span class="o">*</span> <span class="nf">lerp</span><span class="p">(</span><span class="n">dmcShadowColor</span><span class="p">,</span> <span class="n">_ShadowColor</span><span class="p">,</span> <span class="n">lightMap</span><span class="p">.</span><span class="n">b</span><span class="p">);</span>

<span class="n">float4</span> <span class="n">finalColor</span> <span class="o">=</span> <span class="p">...</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="/img/in-post/post-toon-hair-rendering/shadow.jpg" alt="" /></p>

<p><img src="/img/in-post/post-toon-hair-rendering/mask.jpg" alt="" /></p>

<blockquote>
  <p>RitaLightMap：R：高光强度 B：固有阴影强度</p>
</blockquote>

<p><img src="/img/in-post/post-toon-hair-rendering/value.jpg" alt="" /></p>

<p>接下来就剩高光了，仔细观察LightMap，可以发现在绘制高光的时候，高光笔触在中间最亮，往上下逐渐变暗，在粗细发生变化时依旧适用，如此精细的绘制正是高质量高光的基础。</p>

<p>由于我们的高光只与左右旋转有关，与上下旋转无关，所以将H、N投影到观察空间XZ平面进行点乘：</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="n">float4</span> <span class="n">shadowColor</span> <span class="o">=</span> <span class="p">...</span>

<span class="n">float3</span> <span class="n">NV</span> <span class="o">=</span> <span class="n">mul</span><span class="p">(</span><span class="n">UNITY_MATRIX_V</span><span class="p">,</span> <span class="n">N</span><span class="p">);</span>
<span class="n">float3</span> <span class="n">HV</span> <span class="o">=</span> <span class="n">mul</span><span class="p">(</span><span class="n">UNITY_MATRIX_V</span><span class="p">,</span> <span class="n">H</span><span class="p">);</span>

<span class="kt">float</span> <span class="n">NdotH</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">normalize</span><span class="p">(</span><span class="n">NV</span><span class="p">.</span><span class="n">xz</span><span class="p">),</span> <span class="n">normalize</span><span class="p">(</span><span class="n">HV</span><span class="p">.</span><span class="n">xz</span><span class="p">));</span><span class="c1">// xz投影后NdotH</span>


<span class="n">float4</span> <span class="n">finalColor</span> <span class="o">=</span> <span class="n">lerp</span><span class="p">(</span><span class="n">baseColor</span><span class="p">,</span> <span class="n">shadowColor</span><span class="p">,</span> <span class="n">shadowStep</span><span class="p">)</span> <span class="o">+</span> <span class="n">pow</span><span class="p">(</span><span class="n">NdotH</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p><img src="/img/in-post/post-toon-hair-rendering/r2c1x-1x00u.gif" alt="" /></p>

<p>接下来用一些函数和公式控制NdotH的范围，然后拿NdotH控制LightMap阈值进而控制高光的消失与出现。我希望NdotH越大时，阈值越低，高光范围越大，反之阈值越高，高光范围越小，lightStepMin大于lightMap.r时高光消失：</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="rouge-code"><pre><span class="n">_LightColor_H</span> <span class="p">(</span><span class="s">"Light Color H"</span><span class="p">,</span> <span class="n">Color</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">_LightColor_L</span> <span class="p">(</span><span class="s">"Light Color L"</span><span class="p">,</span> <span class="n">Color</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">_LightWidth</span> <span class="p">(</span><span class="s">"Light Width"</span><span class="p">,</span> <span class="n">Range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">=</span> <span class="mf">0.9</span>
<span class="n">_LightLength</span> <span class="p">(</span><span class="s">"Light Length"</span><span class="p">,</span> <span class="n">Range</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">_LightFeather</span> <span class="p">(</span><span class="s">"Light Feather H"</span><span class="p">,</span> <span class="n">Range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span> <span class="o">=</span> <span class="mf">0.2</span>
<span class="n">_LightThreshold</span> <span class="p">(</span><span class="s">"Light Threshold L"</span><span class="p">,</span> <span class="n">Range</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">))</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">_LightIntShadow</span> <span class="p">(</span><span class="s">"Light Intensity In Shadow"</span><span class="p">,</span> <span class="n">Range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">=</span> <span class="mf">0.3</span>
<span class="p">...</span>
<span class="n">float4</span> <span class="n">_LightColor_H</span><span class="p">;</span>
<span class="n">float4</span> <span class="n">_LightColor_L</span><span class="p">;</span>
<span class="kt">float</span> <span class="n">_LightWidth</span><span class="p">;</span>
<span class="kt">float</span> <span class="n">_LightLength</span><span class="p">;</span>
<span class="kt">float</span> <span class="n">_LightFeather</span><span class="p">;</span>
<span class="kt">float</span> <span class="n">_LightThreshold</span><span class="p">;</span>
<span class="kt">float</span> <span class="n">_LightIntShadow</span><span class="p">;</span>

<span class="p">...</span>
<span class="kt">float</span> <span class="n">NdotH</span> <span class="o">=</span> <span class="p">...</span>
<span class="n">NdotH</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="n">NdotH</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="n">_LightWidth</span><span class="p">;</span><span class="c1">//这里将6改为float或属性会遇到一些奇怪的bug，原因不明</span>
<span class="n">NdotH</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="n">NdotH</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">_LightLength</span><span class="p">);</span><span class="c1">//用gamma校正的公式简单控制长度</span>

<span class="kt">float</span> <span class="n">lightFeather</span> <span class="o">=</span> <span class="n">_LightFeather</span> <span class="o">*</span> <span class="n">NdotH</span><span class="p">;</span>
<span class="kt">float</span> <span class="n">lightStepMax</span> <span class="o">=</span> <span class="n">saturate</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">NdotH</span> <span class="o">+</span> <span class="n">lightFeather</span><span class="p">);</span>
<span class="kt">float</span> <span class="n">lightStepMin</span> <span class="o">=</span> <span class="n">saturate</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">NdotH</span> <span class="o">-</span> <span class="n">lightFeather</span><span class="p">);</span>
<span class="n">float3</span> <span class="n">lightColor_H</span> <span class="o">=</span> <span class="n">smoothstep</span><span class="p">(</span><span class="n">lightStepMin</span><span class="p">,</span> <span class="n">lightStepMax</span><span class="p">,</span> <span class="n">clamp</span><span class="p">(</span><span class="n">lightMap</span><span class="p">.</span><span class="n">r</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">))</span> <span class="o">*</span> <span class="n">_LightColor_H</span><span class="p">.</span><span class="n">rgb</span><span class="p">;</span>

<span class="n">float4</span> <span class="n">finalColor</span> <span class="o">=</span> <span class="n">lerp</span><span class="p">(</span><span class="n">baseColor</span><span class="p">,</span> <span class="n">shadowColor</span><span class="p">,</span> <span class="n">shadowStep</span><span class="p">);</span>
<span class="n">finalColor</span><span class="p">.</span><span class="n">rgb</span> <span class="o">+=</span> <span class="n">lightColor_H</span><span class="p">;</span>

<span class="k">return</span> <span class="n">finalColor</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="/img/in-post/post-toon-hair-rendering/e1ktr-uwaxq.gif" alt="" /></p>

<blockquote>
  <p>有内味儿了</p>
</blockquote>

<p>其实到这里核心部分已经结束了，剩下的是一些小修小补。通过另一个阈值控制低频高光范围，调整动态阴影中的高光强度，以及固有阴影中不应有高光：</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="n">float3</span> <span class="n">lightColor_H</span> <span class="o">=</span> <span class="p">...;</span>
<span class="n">float3</span> <span class="n">lightColor_L</span> <span class="o">=</span> <span class="n">smoothstep</span><span class="p">(</span><span class="n">_LightThreshold</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">lightMap</span><span class="p">.</span><span class="n">r</span><span class="p">)</span> <span class="o">*</span> <span class="n">_LightColor_L</span><span class="p">.</span><span class="n">rgb</span><span class="p">;</span>

<span class="n">float4</span> <span class="n">finalColor</span> <span class="o">=</span> <span class="p">...</span>
<span class="n">finalColor</span><span class="p">.</span><span class="n">rgb</span> <span class="o">+=</span> <span class="p">(</span><span class="n">lightColor_H</span> <span class="o">+</span> <span class="n">lightColor_L</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">lightMap</span><span class="p">.</span><span class="n">b</span><span class="p">)</span> <span class="o">*</span> <span class="nf">lerp</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">_LightIntShadow</span><span class="p">,</span> <span class="n">shadowStep</span><span class="p">);</span>

<span class="k">return</span> <span class="n">finalColor</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>完成！</p>

<p><img src="/img/in-post/post-toon-hair-rendering/rxof8-di37c.gif" alt="" /></p>

<p>一些其他实用的效果比如硬标面描边、复杂光照等日后再做分享吧。</p>

<p>丽塔的头发模型和两张贴图已上传群文件（635385414），最后放上完整代码：</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
</pre></td><td class="rouge-code"><pre><span class="c1">// by 喵刀Hime  2020/1/22</span>
<span class="n">Shader</span> <span class="s">"Jason Ma/Hair"</span>
<span class="p">{</span>
    <span class="n">Properties</span>
    <span class="p">{</span>
        <span class="n">_MainTex</span> <span class="p">(</span><span class="s">"Color Map"</span><span class="p">,</span> <span class="mi">2</span><span class="n">D</span><span class="p">)</span> <span class="o">=</span> <span class="s">"white"</span> <span class="p">{</span> <span class="p">}</span>
        <span class="n">_LightMap</span> <span class="p">(</span><span class="s">"Light Map"</span><span class="p">,</span> <span class="mi">2</span><span class="n">D</span><span class="p">)</span> <span class="o">=</span> <span class="s">"white"</span> <span class="p">{</span> <span class="p">}</span>
        <span class="n">_Color</span> <span class="p">(</span><span class="s">"Color"</span><span class="p">,</span> <span class="n">Color</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">_ShadowColor</span> <span class="p">(</span><span class="s">"Shadow Color"</span><span class="p">,</span> <span class="n">Color</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">_DmcShadowIntensity</span> <span class="p">(</span><span class="s">"Dynamic Shadow Intensity"</span><span class="p">,</span> <span class="n">Range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="n">_ShadowThreshold</span> <span class="p">(</span><span class="s">"Shadow Threshold"</span><span class="p">,</span> <span class="n">Range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="p">[</span><span class="n">PowerSlider</span><span class="p">(</span><span class="mi">6</span><span class="p">)]</span><span class="n">_ShadowFeather</span> <span class="p">(</span><span class="s">"Shadow Feather"</span><span class="p">,</span> <span class="n">Range</span><span class="p">(</span><span class="mf">0.0001</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">=</span> <span class="mf">0.01</span>
        
        <span class="n">_LightColor_H</span> <span class="p">(</span><span class="s">"Light Color H"</span><span class="p">,</span> <span class="n">Color</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">_LightColor_L</span> <span class="p">(</span><span class="s">"Light Color L"</span><span class="p">,</span> <span class="n">Color</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">_LightWidth</span> <span class="p">(</span><span class="s">"Light Width"</span><span class="p">,</span> <span class="n">Range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">=</span> <span class="mf">0.9</span>
        <span class="n">_LightLength</span> <span class="p">(</span><span class="s">"Light Length"</span><span class="p">,</span> <span class="n">Range</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="n">_LightFeather</span> <span class="p">(</span><span class="s">"Light Feather H"</span><span class="p">,</span> <span class="n">Range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span> <span class="o">=</span> <span class="mf">0.2</span>
        <span class="n">_LightThreshold</span> <span class="p">(</span><span class="s">"Light Threshold L"</span><span class="p">,</span> <span class="n">Range</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">))</span> <span class="o">=</span> <span class="mf">0.1</span>
        <span class="n">_LightIntShadow</span> <span class="p">(</span><span class="s">"Light Intensity In Shadow"</span><span class="p">,</span> <span class="n">Range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">=</span> <span class="mf">0.3</span>
    <span class="p">}</span>
    
    <span class="n">HLSLINCLUDE</span>
    
    <span class="cp">#include "Packages/com.unity.render-pipelines.core/ShaderLibrary/Common.hlsl"
</span>    <span class="cp">#include "Packages/com.unity.render-pipelines.core/ShaderLibrary/Packing.hlsl"
</span>    <span class="cp">#include "Packages/com.unity.render-pipelines.core/ShaderLibrary/NormalSurfaceGradient.hlsl"
</span>    <span class="cp">#include "Packages/com.unity.render-pipelines.core/ShaderLibrary/Color.hlsl"
</span>    <span class="cp">#include "Packages/com.unity.render-pipelines.core/ShaderLibrary/UnityInstancing.hlsl"
</span>    <span class="cp">#include "Packages/com.unity.render-pipelines.core/ShaderLibrary/EntityLighting.hlsl"
</span>    
    <span class="cp">#include "Packages/com.unity.render-pipelines.high-definition/Runtime/ShaderLibrary/ShaderVariables.hlsl"
</span>    <span class="cp">#include "Packages/com.unity.render-pipelines.high-definition/Runtime/Lighting/Lighting.hlsl"
</span>    
    <span class="n">CBUFFER_START</span><span class="p">(</span><span class="n">UnityPerMaterial</span><span class="p">)</span>
    <span class="n">float4</span> <span class="n">_Color</span><span class="p">;</span>
    <span class="n">float4</span> <span class="n">_ShadowColor</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">_DmcShadowIntensity</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">_ShadowThreshold</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">_ShadowFeather</span><span class="p">;</span>
    
    <span class="n">float4</span> <span class="n">_LightColor_H</span><span class="p">;</span>
    <span class="n">float4</span> <span class="n">_LightColor_L</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">_LightWidth</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">_LightLength</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">_LightFeather</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">_LightThreshold</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">_LightIntShadow</span><span class="p">;</span>
    <span class="n">CBUFFER_END</span>
    
    <span class="n">TEXTURE2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">);</span> <span class="n">SAMPLER</span><span class="p">(</span><span class="n">sampler_MainTex</span><span class="p">);</span>
    <span class="n">TEXTURE2D</span><span class="p">(</span><span class="n">_LightMap</span><span class="p">);</span> <span class="n">SAMPLER</span><span class="p">(</span><span class="n">sampler_LightMap</span><span class="p">);</span>
    
    <span class="n">ENDHLSL</span>
    
    <span class="n">SubShader</span>
    <span class="p">{</span>
        <span class="n">Tags</span> <span class="p">{</span> <span class="s">"RenderType"</span> <span class="o">=</span> <span class="s">"Opaque"</span> <span class="s">"LightMode"</span> <span class="o">=</span> <span class="s">"ForwardOnly"</span> <span class="p">}</span>
        <span class="n">LOD</span> <span class="mi">100</span>
        
        <span class="n">Pass</span>
        <span class="p">{</span>
            <span class="n">HLSLPROGRAM</span>
            
            <span class="cp">#pragma vertex vert
</span>            <span class="cp">#pragma fragment frag
</span>            
            <span class="k">struct</span> <span class="nc">GraphVertexInput</span>
            <span class="p">{</span>
                <span class="n">float4</span> <span class="n">vertex</span><span class="o">:</span> <span class="n">POSITION</span><span class="p">;</span>
                <span class="n">float4</span> <span class="n">texcoord0</span><span class="o">:</span> <span class="n">TEXCOORD0</span><span class="p">;</span>
                <span class="n">float3</span> <span class="n">normal</span><span class="o">:</span> <span class="n">NORMAL</span><span class="p">;</span>
                <span class="n">UNITY_VERTEX_INPUT_INSTANCE_ID</span>
            <span class="p">};</span>
            <span class="k">struct</span> <span class="nc">GraphVertexOutput</span>
            <span class="p">{</span>
                <span class="n">float4</span> <span class="n">position</span><span class="o">:</span> <span class="n">POSITION</span><span class="p">;</span>
                <span class="n">half4</span> <span class="n">uv0</span><span class="o">:</span> <span class="n">TEXCOORD0</span><span class="p">;</span>
                <span class="n">float3</span> <span class="n">positionWS</span><span class="o">:</span> <span class="n">TEXCOORD1</span><span class="p">;</span>
                <span class="n">float3</span> <span class="n">normal</span><span class="o">:</span> <span class="n">TEXCOORD2</span><span class="p">;</span>
            <span class="p">};</span>
            
            <span class="n">GraphVertexOutput</span> <span class="n">vert</span><span class="p">(</span><span class="n">GraphVertexInput</span> <span class="n">v</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">GraphVertexOutput</span> <span class="n">o</span><span class="p">;</span>
                <span class="c1">// 这里的World Space是相对于摄像机的</span>
                <span class="c1">//https://docs.unity3d.com/Packages/com.unity.render-pipelines.high-definition@7.1/manual/Camera-Relative-Rendering.html</span>
                <span class="n">float3</span> <span class="n">positionWS</span> <span class="o">=</span> <span class="n">TransformObjectToWorld</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">vertex</span><span class="p">.</span><span class="n">xyz</span><span class="p">);</span>
                <span class="n">o</span><span class="p">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">TransformWorldToHClip</span><span class="p">(</span><span class="n">positionWS</span><span class="p">);</span>
                <span class="n">o</span><span class="p">.</span><span class="n">positionWS</span> <span class="o">=</span> <span class="n">positionWS</span><span class="p">;</span>
                <span class="n">o</span><span class="p">.</span><span class="n">normal</span> <span class="o">=</span> <span class="n">TransformObjectToWorldNormal</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">normal</span><span class="p">);</span>
                <span class="n">o</span><span class="p">.</span><span class="n">uv0</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="n">texcoord0</span><span class="p">;</span>
                
                <span class="k">return</span> <span class="n">o</span><span class="p">;</span>
            <span class="p">}</span>
            
            <span class="n">float4</span> <span class="n">frag</span><span class="p">(</span><span class="n">GraphVertexOutput</span> <span class="n">i</span><span class="p">)</span><span class="o">:</span> <span class="n">SV_Target0</span>
            <span class="p">{</span>
                <span class="n">float4</span> <span class="n">uv0</span> <span class="o">=</span> <span class="n">i</span><span class="p">.</span><span class="n">uv0</span><span class="p">;</span>
                <span class="c1">//Packages\com.unity.render-pipelines.high-definition@7.1.6\Runtime\Lighting\LightDefinition.cs</span>
                <span class="n">DirectionalLightData</span> <span class="n">light</span> <span class="o">=</span> <span class="n">_DirectionalLightDatas</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
                <span class="n">float3</span> <span class="n">L</span> <span class="o">=</span> <span class="o">-</span><span class="n">light</span><span class="p">.</span><span class="n">forward</span><span class="p">.</span><span class="n">xyz</span><span class="p">;</span>
                <span class="n">float3</span> <span class="n">V</span> <span class="o">=</span> <span class="n">GetWorldSpaceNormalizeViewDir</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">positionWS</span><span class="p">);</span>
                <span class="n">float3</span> <span class="n">H</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">L</span> <span class="o">+</span> <span class="n">V</span><span class="p">);</span>
                <span class="n">float3</span> <span class="n">N</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">normal</span><span class="p">);</span>
                
                <span class="kt">float</span> <span class="n">halfLambert</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">L</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">;</span>
                <span class="kt">float</span> <span class="n">shadowStep</span> <span class="o">=</span> <span class="n">saturate</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="n">halfLambert</span> <span class="o">-</span> <span class="p">(</span><span class="n">_ShadowThreshold</span> <span class="o">-</span> <span class="n">_ShadowFeather</span><span class="p">))</span> <span class="o">/</span> <span class="n">_ShadowFeather</span><span class="p">);</span>
                
                <span class="n">float4</span> <span class="n">lightMap</span> <span class="o">=</span> <span class="n">SAMPLE_TEXTURE2D</span><span class="p">(</span><span class="n">_LightMap</span><span class="p">,</span> <span class="n">sampler_LightMap</span><span class="p">,</span> <span class="n">uv0</span><span class="p">.</span><span class="n">xy</span><span class="p">);</span><span class="c1">// 未使用A通道所以未校正Gamma</span>
                <span class="n">shadowStep</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">shadowStep</span><span class="p">,</span> <span class="n">lightMap</span><span class="p">.</span><span class="n">b</span><span class="p">);</span>
                
                <span class="n">float4</span> <span class="n">baseColor</span> <span class="o">=</span> <span class="n">SAMPLE_TEXTURE2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">sampler_MainTex</span><span class="p">,</span> <span class="n">uv0</span><span class="p">.</span><span class="n">xy</span><span class="p">)</span> <span class="o">*</span> <span class="n">_Color</span><span class="p">;</span>
                <span class="n">float4</span> <span class="n">dmcShadowColor</span> <span class="o">=</span> <span class="n">lerp</span><span class="p">((</span><span class="n">float4</span><span class="p">)</span><span class="mi">1</span><span class="p">,</span> <span class="n">_ShadowColor</span><span class="p">,</span> <span class="n">_DmcShadowIntensity</span><span class="p">);</span>
                <span class="n">float4</span> <span class="n">shadowColor</span> <span class="o">=</span> <span class="n">baseColor</span> <span class="o">*</span> <span class="n">lerp</span><span class="p">(</span><span class="n">dmcShadowColor</span><span class="p">,</span> <span class="n">_ShadowColor</span><span class="p">,</span> <span class="n">lightMap</span><span class="p">.</span><span class="n">b</span><span class="p">);</span>
                
                <span class="n">float3</span> <span class="n">NV</span> <span class="o">=</span> <span class="n">mul</span><span class="p">(</span><span class="n">UNITY_MATRIX_V</span><span class="p">,</span> <span class="n">N</span><span class="p">);</span>
                <span class="n">float3</span> <span class="n">HV</span> <span class="o">=</span> <span class="n">mul</span><span class="p">(</span><span class="n">UNITY_MATRIX_V</span><span class="p">,</span> <span class="n">H</span><span class="p">);</span>
                
                <span class="kt">float</span> <span class="n">NdotH</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">normalize</span><span class="p">(</span><span class="n">NV</span><span class="p">.</span><span class="n">xz</span><span class="p">),</span> <span class="n">normalize</span><span class="p">(</span><span class="n">HV</span><span class="p">.</span><span class="n">xz</span><span class="p">));</span><span class="c1">// xz投影后NdotH</span>
                <span class="n">NdotH</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="n">NdotH</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="n">_LightWidth</span><span class="p">;</span><span class="c1">//这里将6改为float或属性会遇到一些奇怪的bug，原因不明</span>
                <span class="n">NdotH</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="n">NdotH</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">_LightLength</span><span class="p">);</span><span class="c1">//用gamma校正的公式简单控制长度</span>
                
                <span class="kt">float</span> <span class="n">lightFeather</span> <span class="o">=</span> <span class="n">_LightFeather</span> <span class="o">*</span> <span class="n">NdotH</span><span class="p">;</span>
                <span class="kt">float</span> <span class="n">lightStepMax</span> <span class="o">=</span> <span class="n">saturate</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">NdotH</span> <span class="o">+</span> <span class="n">lightFeather</span><span class="p">);</span>
                <span class="kt">float</span> <span class="n">lightStepMin</span> <span class="o">=</span> <span class="n">saturate</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">NdotH</span> <span class="o">-</span> <span class="n">lightFeather</span><span class="p">);</span>
                <span class="n">float3</span> <span class="n">lightColor_H</span> <span class="o">=</span> <span class="n">smoothstep</span><span class="p">(</span><span class="n">lightStepMin</span><span class="p">,</span> <span class="n">lightStepMax</span><span class="p">,</span> <span class="n">clamp</span><span class="p">(</span><span class="n">lightMap</span><span class="p">.</span><span class="n">r</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">))</span> <span class="o">*</span> <span class="n">_LightColor_H</span><span class="p">.</span><span class="n">rgb</span><span class="p">;</span>
                <span class="n">float3</span> <span class="n">lightColor_L</span> <span class="o">=</span> <span class="n">smoothstep</span><span class="p">(</span><span class="n">_LightThreshold</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">lightMap</span><span class="p">.</span><span class="n">r</span><span class="p">)</span> <span class="o">*</span> <span class="n">_LightColor_L</span><span class="p">.</span><span class="n">rgb</span><span class="p">;</span>
                
                <span class="n">float4</span> <span class="n">finalColor</span> <span class="o">=</span> <span class="n">lerp</span><span class="p">(</span><span class="n">baseColor</span><span class="p">,</span> <span class="n">shadowColor</span><span class="p">,</span> <span class="n">shadowStep</span><span class="p">);</span>
                <span class="n">finalColor</span><span class="p">.</span><span class="n">rgb</span> <span class="o">+=</span> <span class="p">(</span><span class="n">lightColor_H</span> <span class="o">+</span> <span class="n">lightColor_L</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">lightMap</span><span class="p">.</span><span class="n">b</span><span class="p">)</span> <span class="o">*</span> <span class="n">lerp</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">_LightIntShadow</span><span class="p">,</span> <span class="n">shadowStep</span><span class="p">);</span>
                
                <span class="k">return</span> <span class="n">finalColor</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">ENDHLSL</span>
            
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<blockquote>
  <p>转自知乎 @喵刀Hime</p>
</blockquote>


                <hr style="visibility: hidden;">
                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2019/08/26/PBR-Rendering/" data-toggle="tooltip" data-placement="top" title="Physically Based Rendering">
                        Previous<br>
                        <span>Physically Based Rendering</span>
                        </a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2019/11/12/Shadow-Algorithm-PCF/" data-toggle="tooltip" data-placement="top" title="Percentage-Closer Filtering PCF">
                        Next<br>
                        <span>Percentage-Closer Filtering PCF</span>
                        </a>
                    </li>
                    
                </ul>
                <hr style="visibility: hidden;">

                

                
            </div>  

    <!-- Side Catalog Container -->
        
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
        

    <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                


<section>
    
        <hr class="hidden-sm hidden-xs">
    
    <h5><a href="/archive/">FEATURED TAGS</a></h5>
    <div class="tags">
        
        
        
        
        
        
                <a data-sort="0007" 
                    href="/archive/?tag=%E5%9B%BE%E5%BD%A2%E5%AD%A6"
                    title="图形学"
                    rel="3">图形学</a>
        
                <a data-sort="0003" 
                    href="/archive/?tag=Shader"
                    title="Shader"
                    rel="7">Shader</a>
        
                <a data-sort="0004" 
                    href="/archive/?tag=%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9B%BE%E5%BD%A2%E5%AD%A6"
                    title="计算机图形学"
                    rel="6">计算机图形学</a>
        
                <a data-sort="0005" 
                    href="/archive/?tag=Unity"
                    title="Unity"
                    rel="5">Unity</a>
        
                <a data-sort="0006" 
                    href="/archive/?tag=%E7%AC%94%E8%AE%B0"
                    title="笔记"
                    rel="4">笔记</a>
        
                <a data-sort="0007" 
                    href="/archive/?tag=%E5%9F%BA%E7%A1%80"
                    title="基础"
                    rel="3">基础</a>
        
                <a data-sort="0008" 
                    href="/archive/?tag=CG"
                    title="CG"
                    rel="2">CG</a>
        
                <a data-sort="0008" 
                    href="/archive/?tag=OpenGL"
                    title="OpenGL"
                    rel="2">OpenGL</a>
    </div>
</section>


                <!-- Friends Blog -->
                
<hr>
<h5>FRIENDS</h5>
<ul class="list-inline">
  
  <li><a href="http://candycat1992.github.io/">Candycat Blog</a></li>
  
  <li><a href="https://roystan.net/">Erik Roystan Ross Blog</a></li>
  
  <li><a href="http://walkingfat.com/">WalkingFat Blog</a></li>
  
  <li><a href="http://qiankanglai.me/">Kanglai Blog</a></li>
  
  <li><a href="http://www.ixulin.com/">徐小厨烹小鲜 Blog</a></li>
  
  <li><a href="https://www.iquilezles.org/">Íñigo Quílez大神 Blog</a></li>
  
  <li><a href="http://www.shaderslab.com/index.html">Shaders Laboratory</a></li>
  
  <li><a href="https://80.lv/">80 Level</a></li>
  
  <li><a href="https://www.shadertoy.com/">Shadertoy</a></li>
  
</ul>

            </div>
        </div>
    </div>
</article>

<!-- add support for mathjax by voleking-->









<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'hover',
          placement: 'right',
          // icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <!-- SNS Link -->
                


<ul class="list-inline text-center">


  
  
  <li>
    <a href="https://twitter.com/Yoko">
      <span class="fa-stack fa-lg">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
      </span>
    </a>
  </li>
  
  
  <li>
    <a target="_blank" href="https://www.zhihu.com/people/Yoko">
      <span class="fa-stack fa-lg">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa  fa-stack-1x fa-inverse">知</i>
      </span>
    </a>
  </li>
  
  
  <li>
    <a target="_blank" href="http://weibo.com/Yoko">
      <span class="fa-stack fa-lg">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
      </span>
    </a>
  </li>
  
  
  
  <li>
    <a target="_blank" href="https://github.com/Yoko">
      <span class="fa-stack fa-lg">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa fa-github fa-stack-1x fa-inverse"></i>
      </span>
    </a>
  </li>
  
  
</ul>

                <p class="copyright text-muted">
                    Copyright &copy; Yoko Blog 2020
                    <br>
                    Powered by <a href="http://Yokowave.github.io">Yoko Blog</a> |
                    <iframe style="margin-left: 2px; margin-bottom:-5px;" frameborder="0" scrolling="0" width="100px"
                        height="20px"
                        src="https://ghbtns.com/github-btn.html?user=huxpro&repo=huxpro.github.io&type=star&count=true">
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<!-- Currently, only navbar scroll-down effect at desktop still depends on this -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js "></script>

<!-- Simple Jekyll Search -->
<script src="/js/simple-jekyll-search.min.js"></script>

<!-- Service Worker -->

<script src="/js/snackbar.js "></script>
<script src="/js/sw-registration.js "></script>


<!-- async load function -->
<script>
    function async(u, c) {
        var d = document, t = 'script',
            o = d.createElement(t),
            s = d.getElementsByTagName(t)[0];
        o.src = u;
        if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
        s.parentNode.insertBefore(o, s);
    }
</script>

<!--
     Because of the native support for backtick-style fenced code blocks
     right within the Markdown is landed in Github Pages,
     From V1.6, There is no need for Highlight.js,
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/
     - https://github.com/jneen/rouge/wiki/list-of-supported-languages-and-lexers
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->







<!--fastClick.js -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js", function () {
        var $nav = document.querySelector("nav");
        if ($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->



<!-- Baidu Tongji -->



<!-- Side Catalog -->

<script type="text/javascript">
    function generateCatalog(selector) {

        // interop with multilangual 
        if ('' == 'true') {
            _containerSelector = 'div.post-container.active'
        } else {
            _containerSelector = 'div.post-container'
        }

        // init
        var P = $(_containerSelector), a, n, t, l, i, c;
        a = P.find('h1,h2,h3,h4,h5,h6');

        // clean
        $(selector).html('')

        // appending
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#" + $(this).prop('id');
            t = $(this).text();
            c = $('<a href="' + i + '" rel="nofollow">' + t + '</a>');
            l = $('<li class="' + n + '_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;
    }

    generateCatalog(".catalog-body");

    // toggle side catalog
    $(".catalog-toggle").click((function (e) {
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    /*
     * Doc: https://github.com/davist11/jQuery-One-Page-Nav
     * Fork by Hux to support padding
     */
    async("/js/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>



<!-- Multi-Lingual -->


<!-- Simple Jekyll Search -->
<script>
    // https://stackoverflow.com/questions/1912501/unescape-html-entities-in-javascript
    function htmlDecode(input) {
        var e = document.createElement('textarea');
        e.innerHTML = input;
        // handle case of empty input
        return e.childNodes.length === 0 ? "" : e.childNodes[0].nodeValue;
    }

    SimpleJekyllSearch({
        searchInput: document.getElementById('search-input'),
        resultsContainer: document.getElementById('search-results'),
        json: '/search.json',
        searchResultTemplate: '<div class="post-preview item"><a href="{url}"><h2 class="post-title">{title}</h2><h3 class="post-subtitle">{subtitle}</h3><hr></a></div>',
        noResultsText: 'No results',
        limit: 50,
        fuzzy: false,
        // a hack to get escaped subtitle unescaped. for some reason, 
        // post.subtitle w/o escape filter nuke entire search.
        templateMiddleware: function (prop, value, template) {
            if (prop === 'subtitle' || prop === 'title') {
                if (value.indexOf("code")) {
                    return htmlDecode(value);
                } else {
                    return value;
                }
            }
        }
    });

    $(document).ready(function () {
        var $searchPage = $('.search-page');
        var $searchOpen = $('.search-icon');
        var $searchClose = $('.search-icon-close');
        var $searchInput = $('#search-input');
        var $body = $('body');

        $searchOpen.on('click', function (e) {
            e.preventDefault();
            $searchPage.toggleClass('search-active');
            var prevClasses = $body.attr('class') || '';
            setTimeout(function () {
                $body.addClass('no-scroll');
            }, 400)

            if ($searchPage.hasClass('search-active')) {
                $searchClose.on('click', function (e) {
                    e.preventDefault();
                    $searchPage.removeClass('search-active');
                    $body.attr('class', prevClasses);  // from closure 
                });
                $searchInput.focus();
            }
        });
    });
</script>


<!-- Image to hack wechat -->
<img src="/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
